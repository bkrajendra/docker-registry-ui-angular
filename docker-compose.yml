# Docker Compose for Docker Registry UI (Angular) with Registry
# Usage: docker compose up -d
# UI: http://localhost (or http://localhost:8080 if running as non-root)
# Registry API is proxied via NGINX when NGINX_PROXY_PASS_URL is set (same-origin, no CORS).

services:
  registry-ui:
    build: .
    image: docker-registry-ui-angular:latest
    restart: always
    ports:
      - "3100:80"
    environment:
      # ---- Registry connection (use proxy for same-origin, avoids CORS) ----
      NGINX_PROXY_PASS_URL: "https://registry-dev.confluxsys.local:5000"
      # Optional: for Docker DNS resolution (e.g. registry-server hostname)
      # NGINX_RESOLVER: "127.0.0.11"

      # ---- UI title and registry display ----
      DOCKER_REGISTRY_UI_TITLE: "Confluxsys Registry UI"
      REGISTRY_TITLE: "Confluxsys Registry UI"
      REGISTRY_URL: ""
      PULL_URL: ""

      # ---- Single registry mode (hide add/change/remove registry menu) ----
      SINGLE_REGISTRY: "false"

      # ---- Features ----
      DELETE_IMAGES: "true"
      SHOW_CONTENT_DIGEST: "true"
      SHOW_TAG_HISTORY: "true"
      SHOW_CATALOG_NB_TAGS: "true"
      ENABLE_VERSION_NOTIFICATION: "true"

      # ---- Catalog ----
      CATALOG_ELEMENTS_LIMIT: "1000"
      CATALOG_DEFAULT_EXPANDED: "false"
      CATALOG_MIN_BRANCHES: "1"
      CATALOG_MAX_BRANCHES: "1"

      # ---- Tag list ----
      TAGLIST_PAGE_SIZE: "100"
      TAGLIST_ORDER: "alpha-asc;num-desc"

      # ---- Registry auth (set true if registry uses Basic Auth) ----
      REGISTRY_SECURED: "false"

      # ---- Cache / headers (for multi-arch) ----
      USE_CONTROL_CACHE_HEADER: "false"

      # ---- Multi-registry (when SINGLE_REGISTRY=false) ----
      # DEFAULT_REGISTRIES: "http://registry1:5000,http://registry2:5000"
      # READ_ONLY_REGISTRIES: "false"

      # ---- History page custom labels (comma-separated) ----
      # HISTORY_CUSTOM_LABELS: "maintainer,version"

      # ---- Theme: light, dark, or auto ----
      THEME: "auto"

      # ---- Nginx (optional) ----
      NGINX_LISTEN_PORT: "80"
    # depends_on:
    #   - registry-server
    container_name: registry-ui

  # registry-server:
  #   image: registry:2.8.2
  #   restart: always
  #   environment:
  #     REGISTRY_HTTP_HEADERS_Access-Control-Allow-Origin: "[http://localhost]"
  #     REGISTRY_HTTP_HEADERS_Access-Control-Allow-Methods: "[HEAD,GET,OPTIONS,DELETE]"
  #     REGISTRY_HTTP_HEADERS_Access-Control-Allow-Credentials: "[true]"
  #     REGISTRY_HTTP_HEADERS_Access-Control-Allow-Headers: "[Authorization,Accept,Cache-Control]"
  #     REGISTRY_HTTP_HEADERS_Access-Control-Expose-Headers: "[Docker-Content-Digest]"
  #     REGISTRY_STORAGE_DELETE_ENABLED: "true"
  #   volumes:
  #     - registry-data:/var/lib/registry
  #   container_name: registry-server

volumes:
  registry-data:
